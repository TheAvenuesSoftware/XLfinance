<!-- collapse all     Ctrl + k + 0 -->
<!-- expand all       Ctrl + k + j -->
<!-- format           Alt + Shift + F (USE WITH CAUTION)-->
<!-- word wrap toggle Alt + z -->
<!-- - Element IDs & Classes: Use kebab-case (e.g., <div id="user-profile">) -->
<!-- - Attributes: Follow HTML syntax conventions, using lowercase (e.g., <input type="text">) -->
<!-- - Custom Attributes: Typically data-* (e.g., data-user-id) -->
    
<!DOCTYPE html>
<html lang="en">
<head>

    <!-- BEST PRACTICE SECTION of <head></head> ELEMENT start -->
        <!-- ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§• -->
        <!-- âœ… Basic Setup START -->
            <!--  -->
                <meta charset="UTF-8">
            <!--  -->
                <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
            <!--  -->
                <title>XL Finance</title>
            <!--  -->
                <!-- <meta name="description" content="Your concise, compelling page summary goes here."> -->
                <meta name="description" content="Safe travelling, information for Australian Ride Share riders and drivers.">
            <!--  -->
                <link rel="canonical" href="https://yourdomain.com/current-page">
        <!-- âœ… Basic Setup END -->

        <!-- ðŸŒ SEO & Social Sharing START -->
            <!--  -->
                <!-- Use meta robots tags only when you want to restrict the way GOOGLE crawls a page; -->
                <meta name="robots" content="index, follow">
            <!--  -->
                <meta property="og:title" content="__projectTemplate">
                <meta property="og:description" content="Your compelling Open Graph summary.">
                <meta property="og:image" content="https://yourdomain.com/images/preview.jpg">
                <meta property="og:url" content="https://yourdomain.com/current-page">
            <!--  -->
                <meta name="twitter:card" content="summary_large_image">
        <!-- ðŸŒ SEO & Social Sharing END -->

        <!-- ðŸ”§ PWA (progressive web app) Setup START -->
            <!-- <link rel="manifest" href="/manifest.json"> -->
            <!-- <meta name="mobile-web-app-capable" content="yes"> -->
            <!-- <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> -->
            <!-- Optional for iOS -->
                <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
            <!-- This is recognized by Chrome on Android and aligns better with current PWA standards. -->
                <!-- <meta name="mobile-web-app-capable" content="yes"> -->
                <!-- <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> -->
        <!-- ðŸ”§ PWA (progressive web app) Setup END -->

        <!-- ðŸ§  Favicons & Icons START -->
            <!-- <link rel="icon" href="/favicon.ico"> -->
            <link id="favicon" rel="icon" type="image/png" href="">
            <link id="apple-touch-icon" rel="apple-touch-icon" href="">
        <!-- ðŸ§  Favicons & Icons END -->

        <!-- âœ¨ Structured Data (JSON-LD) START -->
            <!-- <script type="application/ld+json">
                {
                    "@context": "https://schema.org",
                    "@type": "WebPage",
                    "name": "Your Page Title",
                    "description": "Your page description",
                    "url": "https://yourdomain.com/current-page"
                }
            </script> -->
                <!-- It provides machine-readable metadata about your webpage using the Schema.org vocabulary in JSON-LD format (Linked Data). This is primarily used by:
                Search engines (Google, Bing, etc.)
                Social platforms
                Crawlers / bots
                To better understand and index your content. -->
        <!-- âœ¨ Structured Data (JSON-LD) END -->

        <!-- ðŸ“¦ Preconnect/Preload/Font Optimization START -->
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
            <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
        <!-- ðŸ“¦ Preconnect/Preload/Font Optimization END -->


        <!-- ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§•ðŸ§• -->
    <!-- BEST PRACTICE SECTION of <head></head> ELEMENT end -->

    <link rel="stylesheet" href="./project.css">
    <!-- <link rel="stylesheet" href="projectMenu.css"> -->
    <!-- <link rel="stylesheet" href="global.css"> -->

    <script type="module" src="./globalLogin_Client.mjs"></script>
    <script type="module" src="./globalSessions_Client.mjs"></script>

    <script type="module" src="./global_Client.mjs"></script>
    <script type="module" src="./project_Client.mjs"></script>
    <!-- <script type="module" src="./projectCamera_Client.mjs"></script> -->
    <!-- TinyMCE start -->
        <!-- <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script> -->
         <!-- .....\node_modules\tinymce -->
            <!-- <script src="/tinymce/tinymce.min.js"></script> -->
         <!-- .....\node_modules\tinymce -->
    <!-- TinyMCE end -->
    <script type="module" src="./projectTinyMCE_Client.mjs"></script>
    <!-- <script type="module" src="./projectMenu_Client.mjs"></script> -->
    <script type="module" src="./globalUIpopups_Client.mjs"></script>
    <script type="module" src="./globalUploadImage_Client.mjs"></script>
    
    <!-- <script type="module" src="./global_Client_Dimensions.mjs"></script> -->

    <script type="module" src="./globalConfig_Client.mjs"></script>
    <script type="module" src="./projectConfig_Client.mjs"></script>

    <style>
        /* *{
            border:1px solid red;
        } */
        body {
            margin: 0;
            font-family: sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        main {
            position: relative;
            flex-grow: 1;
            overflow: hidden;
        }
        section {
            position: absolute;
            top: 0; left: 0px; right: 0; bottom: 0;
            flex: 1;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s ease, visibility 0s linear 0.25s;
            padding: 1rem;
        }
        section.active {
            opacity: 1;
            visibility: visible;
            transition-delay: 0.25s;
        }
        .section-heading{
            font-weight: 900;
        }
        /* header START */
            /* Container for all header items */
            .header-controls-container {
                display: flex;
                justify-content: space-between; /* or center, depending on layout */
                align-items: center;
                padding: 0.5rem 1rem;
                background-color: rgb(3, 122, 104);
                color:white;
                font-weight: 900;
            }
            /* Individual control block */
            .header-control {
                margin: 0 0.5rem;
            }
            /* Center the text inside the user-email-address block */
            .user-email-address {
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
                flex: 1; /* makes it grow to fill available space */
            }
            /* additional css to centre email address START */
                .header-controls-container {
                    position: relative; /* important for absolute positioning inside */
                    /* height: 60px; or whatever height fits your design */
                }
                .user-email-address {
                    position: absolute;
                    left: 50%;
                    transform: translateX(-50%);
                    top: 50%;
                    transform: translate(-50%, -50%);
                    text-align: center;
                    white-space: nowrap; /* optional: prevent wrapping */
                }
            /* additional css to centre email address END */
            /* sign IN OUT ICON start */
                header .sign-in-out-icon-container img{
                    display:flex;
                    border-radius: 5px;
                    width:30px;
                    height:25px;
                    cursor:pointer;
                }
                header .sign-in-out-icon-container .icon-hidden{
                        display:none;
                }
            /* sign IN OUT ICON end */
        /* header END */
        /* footer START */
            footer {
                position: relative;
                display: block;
                background-color: rgb(3, 122, 104);
                color: white;
                font-weight: 900;
                padding: 5px 0;
                margin: 0;
            }
            /* Flex layout for controls */
                .footer-controls-container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    position: relative; /* important for absolute positioning inside */
                    padding: 0 1rem;
                }
            /* Icon style */
                .footer-control {
                    padding: 0 2.5px;
                    cursor: pointer;
                    height: 30px;
                    width: 44px;
                }
            .footer-control:hover {
                border: 2px solid black;
            }
        /* footer END */

    </style>

</head>
<body>
    <header>
        <div id="header-controls-container" class="header-controls-container">
            <div id="app-name" class="app-name header-control">
                <span>XL Finance</span>
            </div>
            <div id="user-email-address" class="header-control user-email-address">
                <span>...not signed in.</span>
            </div>
            <div id="sign-in-out-icon-container" class="header-control sign-in-out-icon-container" data-status="signed-out" tabindex="-1" role="button" title="Click to sign in.">
                <img id="padlock-icon" src="__padlock_locked.png" class="icon">
            </div> 
        </div>
    </header>
    <main>
                <section id="section0" class="section0 section-home">
                    <!-- ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ -->
                    <!-- home -->
                        <input id="section0-focus-on-activation" style="position:fixed;left:-5000px;" tabindex="-1">
                        <p class="section-heading">Home</p><br>
                        <p style="text-align: center;"><b>|&nbsp&nbspNo more lost job photos.&nbsp&nbsp|&nbsp&nbspStore them by job address.&nbsp&nbsp|&nbsp&nbspAdd a job note to each photo.&nbsp&nbsp|</b></p><br>
                        <p><strong>Easily find photos searching by:-</strong></p>
                        <ol>
                            <li style="margin-left:20px;">job address; any part of a job address.</li>
                            <li style="margin-left:20px;">job note; any part of a job note.</li>
                            <li style="margin-left:20px;">job date.</li>
                        </ol>
                        <br>
                        <p><strong>Create an account to:</strong></p>
                        <ul>
                            <li style="margin-left:20px;list-style-type: none;">Store and retrieve photos along with the</li>
                            <ul>
                                <li style="margin-left:40px;">address.</li>
                                <li style="margin-left:40px;">date and time taken.</li>
                                <li style="margin-left:40px;">job note.</li>
                            </ul> 
                        </ul> 
                        <br>
                        <p><strong>Your account data security and privacy features:</strong></p>
                        <ol>
                            <li style="margin-left:20px;">Secure login.  A login code is emailed to your chosen email address.  Use the code to access your account.  Your account is not accessible without the one-time-use code.</li>
                            <li style="margin-left:20px;">If your email account is secure, your account and your information stored at Tradie Photo Catalogue is secure.</li>
                            <li style="margin-left:20px;">No images are stored on the Tradie Photo Catalogue server.  Images are stored as non-viewable data but they are rendered in your browser as viewable images.</li>
                        </ol>
                    <!-- ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ðŸ¡ -->
                </section>
                <section id="section1" class="section1 section-uploads">
                    <!-- ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ -->
                    <!-- menu -->
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
    }
    input[type="file"] {
      margin-bottom: 1rem;
    }
    pre {
      background: #f4f4f4;
      padding: 1rem;
      border-radius: 4px;
      max-height: 400px;
      overflow: auto;
    }
    /* Default: show table, hide cards */
        #mobile-card-container {
            display: none;
        }
        #desktop-table-container {
            display: block;
        }
    /* On mobile: show cards, hide table */
        @media screen and (max-width: 768px) {
            #mobile-card-container {
                display: block;
            }
            #desktop-table-container {
                display: none;
            }
        }

#transactionsTable th,
#transactionsTable td {
  padding: 8px;
  text-align: left;
  border: 1px solid #ddd;
  font-size: 14px;
}

#transactionsTable tr:hover {
  background-color: #f1f1f1;
}

  </style>
    <h1>Upload CSV File</h1>

    <label for="accountEmail">Account Email Address:</label>
    <input type="text" id="accountEmail" placeholder="me@email.com" required />
    <label for="portfolioId">Portfolio ID:</label>
    <input type="text" id="portfolioId" placeholder="e.g. ACC-12345" required />
    <label for="portfolioName">Account Name:</label>
    <input type="text" id="portfolioName" placeholder="e.g. Primary Investment" required />
    <br>
    <input type="file" id="csvFileInput" accept=".csv" style="display:none" />
    <label for="csvFileInput" id="customUploadButton" style="cursor: pointer;"><button type="button">ðŸ“¤ Upload new transactions, choose file.</button></label>
    <!--
        The <pre> tag is used to display text exactly as it is written in the HTML source, preserving:
        -   Whitespace (spaces and tabs)
        -   Line breaks
        -   Monospaced font (by default) 
        -->
        <!-- document.getElementById('output').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`; -->
        <pre id="output" style="display:none"></pre> 
    <!--  -->

    <br>
    <button id="saveButton">ðŸ’¾ Append to existing file / Create new file.</button>
    <br>

    <div id="desktop-table-container">
        <!-- Your desktop table here -->
    </div>

    <div id="mobile-card-container">
        <!-- Cards rendered here via JS -->
    </div>

    <input type="text" id="tableFilter" placeholder="Filter transactions..." style="margin-bottom: 10px; padding: 5px; width: 100%; max-width: 400px;" />
    <div id="desktop-table-container" style="overflow-x: auto; max-height: 80vh;"></div>

  <script>

        if (!window.showSaveFilePicker || !window.showOpenFilePicker) {
        alert("Your browser doesn't support the File System Access API.");
        }

        function renderTransactions(data) {
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                document.getElementById('desktop-table-container').style.display = 'none';
                document.getElementById('mobile-card-container').style.display = 'block';
                renderCards(data);
            } else {
                document.getElementById('mobile-card-container').style.display = 'none';
                document.getElementById('desktop-table-container').style.display = 'block';
                renderTable(data);
            }
        }

    // function parseTransactions(csvText) {
    //   const lines = csvText.trim().split('\n');
    //   const headers = lines[0].split(',').map(h => h.trim());
    // 
    //   return lines.slice(1).map(line => {
    //     const values = line.split(',').map(v => v.trim());
    //     const row = Object.fromEntries(headers.map((h, i) => [h, values[i] || '']));
    // 
    //     const result = {
    //       Date: row.Date,
    //       Reference: row.Reference,
    //       Debit: row["Debit($)"],
    //       Credit: row["Credit($)"],
    //       Balance: row["Balance($)"]
    //     };
    // 
    //     const details = row.Details;
    // 
    //     // B or S transaction
    //     if (/^[BS]\s+\d+/.test(details)) {
    //       const [trxType, trxQty, trxTicker, atSymbol, trxUnitAmount] = details.split(/\s+/);
    //       Object.assign(result, {
    //         trxType,
    //         trxQty,
    //         trxTicker,
    //         trx: atSymbol,
    //         trxUnitAmount
    //       });
    //     }
    //     // Payee
    //     else if (/Payee/i.test(details)) {
    //       const match = details.match(/Payee\s+(.*)/i);
    //       result.Payee = match ? match[1].trim() : '';
    //     }
    //     // Drawer
    //     else if (/Drawer/i.test(details)) {
    //       const match = details.match(/Drawer\s+(.*)/i);
    //       result.Drawer = match ? match[1].trim() : '';
    //     }
    //     // Fallback
    //     else {
    //       result.Details = details;
    //     }
    // 
    //     return result;
    //   });
    // }

    // function parseTransactions(csvText) {
    // const lines = csvText.trim().split('\n');
    // const headers = lines[0].split(',').map(h => h.trim());
    // 
    // return lines.slice(1).map(line => {
    //     const values = line.split(',').map(v => v.trim());
    //     const row = Object.fromEntries(headers.map((h, i) => [h, values[i] || '']));
    // 
    //     const result = {
    //     Date: row.Date,
    //     Reference: row.Reference,
    //     Debit: row["Debit($)"],
    //     Credit: row["Credit($)"],
    //     Balance: row["Balance($)"]
    //     };
    // 
    //     const details = row.Details;
    // 
    //     // 1. B or S transactions
    //     if (/^[BS]\s+\d+/.test(details)) {
    //     const [trxType, trxQty, trxTicker, atSymbol, trxUnitAmount] = details.split(/\s+/);
    //     Object.assign(result, {
    //         trxType,
    //         trxQty,
    //         trxTicker,
    //         trx: atSymbol,
    //         trxUnitAmount
    //     });
    //     }
    // 
    //     // 2. Drawer
    //     else if (/Drawer/i.test(details)) {
    //     const match = details.match(/Drawer\s+(.*)/i);
    //     result.Drawer = match ? match[1].trim() : '';
    //     result.trxType = 'R';
    //     }
    // 
    //     // 3. Payee
    //     else if (/Payee/i.test(details)) {
    //     const match = details.match(/Payee\s+(.*)/i);
    //     result.Payee = match ? match[1].trim() : '';
    //     result.trxType = 'P';
    //     }
    // 
    //     // 4. Reference starts with J
    //     else if (/^J/i.test(row.Reference)) {
    //     result.trxType = 'J';
    //     result.Details = details;
    //     }
    // 
    //     // 5. Fallback
    //     else {
    //     result.Details = details;
    //     }
    // 
    //     return result;
    // });
    // }
    // 
    // document.getElementById('csvFileInput').addEventListener('change', function(event) {
    //   const file = event.target.files[0];
    //   if (!file) return;
    // 
    //   const reader = new FileReader();
    // 
    //   reader.onload = function(e) {
    //     const csvText = e.target.result;
    //     const parsedData = parseTransactions(csvText);
    //     document.getElementById('output').textContent = JSON.stringify(parsedData, null, 2);
    //     console.log("Parsed JSON:", parsedData);
    //   };
    // 
    //   reader.readAsText(file);
    // });

    function parseTransactions(csvText, accountEmail, portfolioId, portfolioName) {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());

      return lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim());
        const row = Object.fromEntries(headers.map((h, i) => [h, values[i] || '']));

        const details = row.Details;

        // Start with accountEmail/portfolioId/portfolioName at beginning
        const result = {
          accountEmail: accountEmail,
          portfolioId: portfolioId,
          portfolioName: portfolioName,
          original: line,
          Date: row.Date,
          Reference: row.Reference,
          Debit: row["Debit($)"],
          Credit: row["Credit($)"],
          Balance: row["Balance($)"]
        };

        // 1. B or S transaction
        if (/^[BS]\s+\d+/.test(details)) {
          const [trxType, trxQty, trxTicker, atSymbol, trxUnitAmount] = details.split(/\s+/);
          Object.assign(result, {
            trxType,
            trxQty,
            trxTicker,
            trx: atSymbol,
            trxUnitAmount,
            Brokerage_inclGST: Math.abs(( trxQty * trxUnitAmount - row["Credit($)"] - row["Debit($)"] )).toFixed(2),
            GST: Math.abs((( trxQty * trxUnitAmount - row["Credit($)"] - row["Debit($)"] )) / 11).toFixed(2)
          });
        }
        // 2. Drawer
        else if (/Drawer/i.test(details)) {
          const match = details.match(/Drawer\s+(.*)/i);
          result.Drawer = match ? match[1].trim() : '';
          result.trxType = 'R';
        }
        // 3. Payee
        else if (/Payee/i.test(details)) {
          const match = details.match(/Payee\s+(.*)/i);
          result.Payee = match ? match[1].trim() : '';
          result.trxType = 'P';
        }
        // 4. Reference starts with J
        else if (/^J/i.test(row.Reference)) {
          result.trxType = 'J';
          result.Details = details;
        }
        // 5. Fallback
        else {
          result.Details = details;
        }

        return result;
      });
    }

    document.getElementById('csvFileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const accountEmail = document.getElementById('accountEmail').value.trim();
      const portfolioId = document.getElementById('portfolioId').value.trim();
      const portfolioName = document.getElementById('portfolioName').value.trim();

      if (!accountEmail || !portfolioId || !portfolioName) {
        alert("Please enter: Account Email Address; Portfolio ID and Account Name before uploading.");
        return;
      }

      const reader = new FileReader();

      reader.onload = function (e) {
        const csvText = e.target.result;
        const parsedData = parseTransactions(csvText, accountEmail, portfolioId, portfolioName);
        // document.getElementById('output').textContent = JSON.stringify(parsedData, null, 2); // renders raw json of imported csv file
        renderTransactions(parsedData);
        console.log("Parsed JSON:", parsedData);
        window.localStorage.setItem("XLfinance_parsedData",JSON.stringify(parsedData));
      };

      reader.readAsText(file);
    });

    // desktop display START
        // ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»
            // function renderTable(data) {
            // const container = document.getElementById('desktop-table-container');
            // container.innerHTML = `
            //     <table border="1" style="width: 100%; border-collapse: collapse;">
            //     <thead>
            //         <tr>
            //         <th>Date</th>
            //         <th>Reference</th>
            //         <th>Type</th>
            //         <th>Qty</th>
            //         <th>Ticker</th>
            //         <th>Unit Amount</th>
            //         <th>Debit</th>
            //         <th>Credit</th>
            //         <th>Balance</th>
            //         <th>Payee</th>
            //         <th>Drawer</th>
            //         </tr>
            //     </thead>
            //     <tbody id="transactionsBody"></tbody>
            //     </table>
            // `;
            // 
            // const tbody = container.querySelector('#transactionsBody');
            // data.forEach(txn => {
            //     const tr = document.createElement('tr');
            //     tr.innerHTML = `
            //     <td>${txn.Date || ''}</td>
            //     <td>${txn.Reference || ''}</td>
            //     <td>${txn.trxType || ''}</td>
            //     <td>${txn.trxQty || ''}</td>
            //     <td>${txn.trxTicker || ''}</td>
            //     <td>${txn.trxUnitAmount || ''}</td>
            //     <td>${txn.Debit || ''}</td>
            //     <td>${txn.Credit || ''}</td>
            //     <td>${txn.Balance || ''}</td>
            //     <td>${txn.Payee || ''}</td>
            //     <td>${txn.Drawer || ''}</td>
            //     `;
            //     tbody.appendChild(tr);
            // });
            // }
            function renderTable(data) {
            const container = document.getElementById('desktop-table-container');
            container.innerHTML = '';

            const table = document.createElement('table');
            table.id = 'transactionsTable';
            table.style.cssText = `
                width: 100%;
                border-collapse: collapse;
            `;

            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            tbody.id = 'transactionsBody';

            const headers = [
                "Date", "Reference", "Type", "Qty", "Ticker", "Unit Amount",
                "Debit", "Credit", "Balance", "Brokerage_inclGST", "GST", "Payee", "Drawer"
            ];

            // Create header row
            const headerRow = document.createElement('tr');
            headers.forEach((h, idx) => {
                const th = document.createElement('th');
                th.textContent = h;
                th.style.cssText = `
                position: sticky;
                top: 0;
                background: #f2f2f2;
                padding: 8px;
                border-bottom: 2px solid #999;
                cursor: pointer;
                `;
                th.dataset.index = idx;
                th.addEventListener('click', () => sortTableByColumn(idx));
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            table.appendChild(tbody);
            container.appendChild(table);

            populateTable(data);

            // Filter listener
            const filterInput = document.getElementById('tableFilter');
            filterInput.addEventListener('input', () => {
                const filterValue = filterInput.value.toLowerCase();
                const filtered = data.filter(txn =>
                Object.values(txn).some(val => String(val).toLowerCase().includes(filterValue))
                );
                populateTable(filtered);
            });

            function populateTable(rows) {
                tbody.innerHTML = '';
                rows.forEach(txn => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${txn.Date || ''}</td>
                    <td>${txn.Reference || ''}</td>
                    <td>${txn.trxType || ''}</td>
                    <td>${txn.trxQty || ''}</td>
                    <td>${txn.trxTicker || ''}</td>
                    <td>${txn.trxUnitAmount || ''}</td>
                    <td>${txn.Debit || ''}</td>
                    <td>${txn.Credit || ''}</td>
                    <td>${txn.Balance || ''}</td>
                    <td>${txn.Brokerage_inclGST || ''}</td>
                    <td>${txn.GST || ''}</td>
                    <td>${txn.Payee || ''}</td>
                    <td>${txn.Drawer || ''}</td>
                `;
                tbody.appendChild(tr);
                });
            }

            // Basic sort handler
            function sortTableByColumn(columnIndex) {
                let ascending = table.dataset.sortDir !== 'asc';
                table.dataset.sortDir = ascending ? 'asc' : 'desc';

                const sorted = [...data].sort((a, b) => {
                const valA = Object.values(a)[columnIndex] || '';
                const valB = Object.values(b)[columnIndex] || '';

                const numA = parseFloat(valA);
                const numB = parseFloat(valB);

                if (!isNaN(numA) && !isNaN(numB)) {
                    return ascending ? numA - numB : numB - numA;
                }

                return ascending
                    ? String(valA).localeCompare(String(valB))
                    : String(valB).localeCompare(String(valA));
                });

                populateTable(sorted);
            }
            }
        // ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»ðŸ’»
    // desktop display END

    // mobile display START
        // ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±
            function renderCards(data) {
            const container = document.getElementById('mobile-card-container');
            container.innerHTML = '';

            data.forEach(txn => {
                const card = document.createElement('div');
                card.style.cssText = `
                border: 1px solid #ccc;
                border-radius: 8px;
                margin: 10px 0;
                padding: 10px;
                background-color: #f9f9f9;
                `;

                card.innerHTML = `
                <strong>Date:</strong> ${txn.Date || ''}<br>
                <strong>Reference:</strong> ${txn.Reference || ''}<br>
                <strong>Type:</strong> ${txn.trxType || ''}<br>
                ${txn.trxQty ? `<strong>Qty:</strong> ${txn.trxQty}<br>` : ''}
                ${txn.trxTicker ? `<strong>Ticker:</strong> ${txn.trxTicker}<br>` : ''}
                ${txn.trxUnitAmount ? `<strong>Unit Amount:</strong> ${txn.trxUnitAmount}<br>` : ''}
                ${txn.Payee ? `<strong>Payee:</strong> ${txn.Payee}<br>` : ''}
                ${txn.Drawer ? `<strong>Drawer:</strong> ${txn.Drawer}<br>` : ''}
                <strong>Debit:</strong> ${txn.Debit || ''}<br>
                <strong>Credit:</strong> ${txn.Credit || ''}<br>
                <strong>Balance:</strong> ${txn.Balance || ''}<br>
                `;
                container.appendChild(card);
            });
            }
        // ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±ðŸ“±
    // mobile display END

</script>
</body>
</html>

                    <!-- ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ðŸ’ -->
                </section>
                <section id="section2" class="section2 section-open">
                        <label for="accountEmail">Account Email Address:</label>
                        <input type="text" id="accountEmail" placeholder="me@email.com" required />
                        <label for="portfolioId">Portfolio ID:</label>
                        <input type="text" id="portfolioId" placeholder="e.g. ACC-12345" required />
                        <label for="portfolioName">Account Name:</label>
                        <input type="text" id="portfolioName" placeholder="e.g. Primary Investment" required />

                        <button id="openButton">ðŸ“‚ Open file</button>
                        <pre id="loadedFileContent" style="display:none"></pre>

                        <div id="desktop-table-container">
                            <!-- Your desktop table here -->
                        </div>

                        <div id="mobile-card-container">
                            <!-- Cards rendered here via JS -->
                        </div>

                        <input type="text" id="tableFilter" placeholder="Filter transactions..." style="margin-bottom: 10px; padding: 5px; width: 100%; max-width: 400px;" />
                        <div id="desktop-table-container" style="overflow-x: auto; max-height: 80vh;"></div>
                </section>
                <section id="section3" class="section3 section-googleAPIs">
                    <!-- ðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“Œ -->
                    <!-- address -->
                        <!-- <input id="section3-focus-on-activation" style="position:fixed;left:-5000px;" tabindex="-1">
                        <p class="section-heading">Address</p>
                        <div class="autocomplete-address-container">
                            <input id="googlePlacesAPIautocomplete_0" class="autocomplete-address-input" type="text" placeholder="Enter address here...">
                        </div>
                        <div id="map-container" class="map-container">
                            <button id="close-map" class="close-map-btn" >Close Map</button>
                            <div id="map" class="map"></div>
                        </div> -->
                    <!-- ðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“ŒðŸ“Œ -->
                </section>
                <section id="section4" class="section4 section-note">
                    <!-- ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ -->
                    <!-- note -->
                        <!-- <input id="section4-focus-on-activation" style="position:fixed;left:-5000px;" tabindex="-1">
                        <p class="section-heading">Note</p>
                        <p id="note-date-time">&nbsp</p>
                        <p id="note-address">&nbsp</p>
                        <textarea id="tinymce_0" class="tinymce-editor"></textarea> -->
                    <!-- ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ðŸ“ðŸ–‹ï¸ -->
                </section>
                <section id="section5" class="section5 section-save">
                    <!-- ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ -->
                    <!-- save -->
                        <!-- <input id="section5-focus-on-activation" style="position:fixed;left:-5000px;" tabindex="-1">
                        <p class="section-heading">Review and Save</p>
                        <p><b><u>Address:-</u></b></p>
                        <div id="save_address" class="save-address"></div>
                        <br>
                        <p><b><u>Note:-</u></b></p>
                        <div id="save_note_0" class="save-note_0 tinymce-textarea"></div>
                        <br>
                        <p><b><u>Photo:-</u></b></p>
                        <div id="canvas-container-II" class="save-canvas" style="flex-direction: column; align-items: center;">
                            <canvas id="canvasII"></canvas>
                        </div>
                        <button class="std-btn mapped-event" data-action="insertFormDataRecord">ADD NEW: Photo, Address & Note.</button> -->
                    <!-- ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ðŸ’¾ -->
                </section>
                <section id="section6" class="section6 section-search">
                    <!-- ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ” -->
                    <!-- search -->
                        <!-- <input id="section6-focus-on-activation" style="position:fixed;left:-5000px;" tabindex="-1">
                        <p class="section-heading">Search</p>
                        <form id="search-criteria" class="search-criteria">
                            <span>Search by:</span>
                            <label>
                                <input type="radio" name="searchOption" data-action="searchByAddress" value="address" />
                                Part of an address
                            </label>
                            <label>
                                <input type="radio" name="searchOption" data-action="searchByNote" value="note" />
                                Part of a note
                            </label>
                            <label>
                                <input type="radio" name="searchOption" data-action="searchByDate" value="date" />
                                Date
                            </label>
                        </form>
                        <div class="search-container">
                            <input id="search-input" class="search-input" type="text" placeholder="Enter search term...">
                            <div style="text-align: center;">
                                <button id="search-button" class="std-btn">Search</button>
                            </div>
                        </div>
                        <div id="search-results" class="search-results">
                            <p class="section-heading">Search Results</p>
                            <ul id="filteredList-container">
                            </ul>
                        </div> -->
                    <!-- ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”ðŸ” -->
                </section>

    </main>

    <footer>
        <div id="footer-controls-container" class="footer-controls-container">
            <img id="footer-control-home" src="/_Home.png" class="footer-control" data-section-number="0">
            <img id="footer-control-menu" src="/_Menu.png" class="footer-control" data-section-number="1">
            <img id="footer-control-camera" src="/_fileOpen.png" class="footer-control" data-section-number="2">
            <img id="footer-control-address" src="/_fileUpload.png" class="footer-control" data-section-number="3">
            <img id="footer-control-notes" src="/_Note.png" class="footer-control" data-section-number="4">
            <img id="footer-control-save" src="/_fileSave.png" class="footer-control" data-section-number="5">
            <img id="footer-control-search" src="/_Search.png" class="footer-control" data-section-number="6">
        </div>
    </footer>
    <script>
        // section focus and switch START
            function focusInput(sectionId) {
                const input = document.querySelector(`#section${sectionId}-focus-on-activation`);
                input?.focus();
            }
            function switchSection(index) {
                console.log(current,index);
                if (index === current) return;
                const currentSection = document.getElementById(`section${current}`);
                console.log(currentSection);
                const nextSection = document.getElementById(`section${index}`);
                currentSection.classList.remove('active');
                setTimeout(() => {
                    nextSection.classList.add('active');
                    console.log(nextSection);
                    current = index;
                    focusInput(index);
                    localStorage.setItem("tas_sectionNumber",index);
                }, 250); // Matches the CSS transition duration of 0.25s
            }
            document.getElementById("footer-controls-container").addEventListener("click",(ev) => {
                const sectionNumber = ev.target.getAttribute("data-section-number");
                switchSection(sectionNumber);
            });
            // set current section = last active section START
                let current = localStorage.getItem("tas_sectionNumber")? localStorage.getItem("tas_sectionNumber") : 0; // start-up at last active section
                const el = document.getElementById(`section${current}`);
                el.classList.add("active");
                switchSection(current); // ensure last active section is viewable
                focusInput(current); // set focus to active section
            // set current section = last active section END
        // section focus and switch END

        // // re-load START
        //     // Only clear session once
        //     const cleared = sessionStorage.getItem('sessionCleared');            
        //     if (!cleared) {
        //         console.log('âœ… Session reset commenced');
        //         fetch('/session-reset?reload=true', {
        //             method: 'GET',
        //             // credentials: 'same-origin' // Send credentials only if the request URL is on the same origin (same scheme, host, and port) as the calling script.
        //             credentials: 'include'// Always send credentials, even for cross-origin requests (if CORS allows it).
        //         })
        //         .then(res => res.json())
        //         .then(data => {
        //             if (data.success) {
        //                 console.log('âœ… Session reset successful');
        //                 sessionStorage.setItem('sessionCleared', 'true');
        //                 // optionally redirect or update UI
        //             } else {
        //                 console.warn('âš ï¸ Session reset failed:', data.message);
        //             }
        //         })
        //         .catch(err => {
        //             console.error('ðŸš¨ Session reset request failed:', err);
        //         });
        //     }
        // // re-load END

let fileHandle; // persist file handle for saving
let savedEmail = ''; // to create consistent file name
// Save to NDJSON file
document.getElementById('saveButton').addEventListener('click', async () => {
  try {
    if (!window.showSaveFilePicker) {
      alert('This feature requires a supported browser (e.g., Chrome).');
      return;
    }

    const jsonString = window.localStorage.getItem("XLfinance_parsedData");
    const parsedData = JSON.parse(jsonString);
    if (!parsedData || parsedData.length === 0) {
      alert('No parsed data to save.');
      return;
    }

    const accountEmail = parsedData[0]?.accountEmail || 'unknown';
    savedEmail = accountEmail;

    const fileName = `XLfinance_${accountEmail}.ndjson`;

    if (!fileHandle) {
      fileHandle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{
          description: 'NDJSON File',
          accept: { 'application/x-ndjson': ['.ndjson'] }
        }]
      });
    }

    const writable = await fileHandle.createWritable({ keepExistingData: true });

    for (const record of parsedData) {
      await writable.write(JSON.stringify(record) + '\n');
    }

    await writable.close();
    alert('File saved successfully.');
  } catch (err) {
    console.error('Save error:', err);
    alert('Could not save file.');
  }
});

// Open existing NDJSON file
document.getElementById('openButton').addEventListener('click', async () => {
  try {
    if (!window.showOpenFilePicker) {
      alert('This feature requires a supported browser (e.g., Chrome).');
      return;
    }

    const [handle] = await window.showOpenFilePicker({
      types: [{
        description: 'NDJSON File',
        accept: { 'application/x-ndjson': ['.ndjson'] }
      }]
    });

    const file = await handle.getFile();
    const text = await file.text();

    // Optional: parse into objects
    const ndjsonLines = text.trim().split('\n');
    const parsedObjects = ndjsonLines.map(line => JSON.parse(line));

    // document.getElementById('loadedFileContent').style.display="block";
    // document.getElementById('loadedFileContent').textContent = JSON.stringify(parsedObjects, null, 2);
    document.getElementById("accountEmail").value = parsedObjects[0].accountEmail;
    document.getElementById("portfolioId").value = parsedObjects[0].portfolioId;
    document.getElementById("portfolioName").value = parsedObjects[0].portfolioName;
    renderTransactions(parsedObjects);

    console.log('Loaded records:', parsedObjects);
  } catch (err) {
    console.error('Open error:', err);
    alert('Could not open file.');
  }
});


    </script>
</body>
</html>